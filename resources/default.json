{
  "variables": {
    "home": "{{env `HOME`}}",
    "git_sha": "{{env `PACKER_GIT_SHA`}}",
    "git_branch": "{{env `PACKER_GIT_BRANCH`}}",
    "service_name": "{{env `SERVICE_NAME`}}"
  },
  "builders": [
    {
      "type": "virtualbox-ovf",
      "source_path": "{{user `home`}}/.vagrant.d/boxes/udacity-VAGRANTSLASH-puppet-masterless/0.0.1/virtualbox/box.ovf",
      "ssh_username": "vagrant",
      "ssh_password": "vagrant",
      "headless": true,
      "ssh_wait_timeout": "30s",
      "shutdown_command": "sudo shutdown -h now"
    }
  ],
  "provisioners": [
    {
      "type": "file",
      "source": "{{user `service_name`}}.tar",
      "destination": "/tmp/{{user `service_name`}}.tar"
    },
    {
      "type": "puppet-masterless",
      "manifest_file": "default.pp",
      "module_paths": ["modules"],
      "execute_command": "{{.FacterVars}}{{if .Sudo}} sudo -E {{end}}puppet apply --debug --modulepath='/tmp/packer-puppet-masterless/module-0:/etc/puppet/modules' --detailed-exitcodes {{.ManifestFile}}"
    }
  ],
  "post-processors": ["vagrant"]
}
